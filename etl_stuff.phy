import psycopg2
import pygrametl
from pygrametl.datasources import SQLSource
from pygrametl.tables import Dimension, SlowlyChangingDimension, FactTable

sales_pgconn = psycopg2.connect("host=localhost dbname='fkluboltp' user='postgres' password='takecare'")
dw_pgconn = psycopg2.connect("host=localhost dbname='fklubdw' user='postgres' password='takecare'")

dw_conn_wrapper = pygrametl.ConnectionWrapper(connection=dw_pgconn)

location_source = SQLSource(connection=sales_pgconn, query="SELECT id, description FROM room")
sales_source = SQLSource(connection=sales_pgconn, query="SELECT * FROM sale")
member_source = SQLSource(connection=sales_pgconn, query="select id, year, semester from member, semestergroups where member.id = semestergroups.member_id")

location_dimension = Dimension(
  name='location',
  key='id',
  attributes=['name', 'locationid'],
  lookupatts=['locationid'])

member_dimension = Dimension(
  name='member',
  key='id',
  attributes=['joinyear', 'study', 'memberid'],
  lookupatts=['memberid'])

fact_table = FactTable(
  name='sale',
  keyrefs=['locationid'],
  measures=['price'])

#for row in sales_source:
  #print row
  #row['locationid'] = location_dimension.ensure(row, {'sourceid':'roomid'})
  #fact_table.ensure(row)


dw_conn_wrapper.commit()
dw_conn_wrapper.close()